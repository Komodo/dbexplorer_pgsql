<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Basic module usage &mdash; Psycopg v2.0.14 documentation</title>
    <link rel="stylesheet" href="_static/psycopg.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '#',
        VERSION:     '2.0.14',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Psycopg v2.0.14 documentation" href="index.html" />
    <link rel="next" title="The psycopg2 module content" href="module.html" />
    <link rel="prev" title="Psycopg – PostgreSQL database adapter for Python" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="modindex.html" title="Global Module Index"
             accesskey="M">modules</a> |</li>
        <li class="right" >
          <a href="module.html" title="The psycopg2 module content"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Psycopg – PostgreSQL database adapter for Python"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Psycopg v2.0.14 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="basic-module-usage">
<h1>Basic module usage<a class="headerlink" href="#basic-module-usage" title="Permalink to this headline">¶</a></h1>
<p id="index-256">The basic Psycopg usage is common to all the database adapters implementing
the <a class="reference external" href="http://www.python.org/dev/peps/pep-0249/">DB API 2.0</a> protocol. Here is an interactive session showing some of the
basic commands:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">psycopg2</span>

<span class="go"># Connect to an existing database</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;dbname=test user=postgres&quot;</span><span class="p">)</span>

<span class="go"># Open a cursor to perform database operations</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

<span class="go"># Execute a command: this creates a new table</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE test (id serial PRIMARY KEY, num integer, data varchar);&quot;</span><span class="p">)</span>

<span class="go"># Pass data to fill a query placeholders and let Psycopg perform</span>
<span class="go"># the correct conversion (no more SQL injections!)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO test (num, data) VALUES (</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&quot;</span><span class="p">,</span>
<span class="gp">... </span>     <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s">&quot;abc&#39;def&quot;</span><span class="p">))</span>

<span class="go"># Query the database and obtain data as Python objects</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT * FROM test;&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="go">(1, 100, &quot;abc&#39;def&quot;)</span>

<span class="go"># Make the changes to the database persistent</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="go"># Close communication with the database</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>The main entry point of Psycopg are:</p>
<ul class="simple">
<li>The function <a title="psycopg2.connect" class="reference external" href="module.html#psycopg2.connect"><tt class="xref docutils literal"><span class="pre">connect()</span></tt></a> creates a new database session and
returns a new <a title="connection" class="reference external" href="connection.html#connection"><tt class="xref docutils literal"><span class="pre">connection</span></tt></a> instance.</li>
<li>The class <a title="connection" class="reference external" href="connection.html#connection"><tt class="xref docutils literal"><span class="pre">connection</span></tt></a> encapsulates a database session. It allows to:<ul>
<li>create new <a title="cursor" class="reference external" href="cursor.html#cursor"><tt class="xref docutils literal"><span class="pre">cursor</span></tt></a>s using the <a title="connection.cursor" class="reference external" href="connection.html#connection.cursor"><tt class="xref docutils literal"><span class="pre">cursor()</span></tt></a> method to
execute database commands and queries,</li>
<li>terminate the session using the methods <a title="connection.commit" class="reference external" href="connection.html#connection.commit"><tt class="xref docutils literal"><span class="pre">commit()</span></tt></a> or
<a title="connection.rollback" class="reference external" href="connection.html#connection.rollback"><tt class="xref docutils literal"><span class="pre">rollback()</span></tt></a>.</li>
</ul>
</li>
<li>The class <a title="cursor" class="reference external" href="cursor.html#cursor"><tt class="xref docutils literal"><span class="pre">cursor</span></tt></a> allows interaction with the database:<ul>
<li>send commands to the database using methods such as <a title="cursor.execute" class="reference external" href="cursor.html#cursor.execute"><tt class="xref docutils literal"><span class="pre">execute()</span></tt></a>
and <a title="cursor.executemany" class="reference external" href="cursor.html#cursor.executemany"><tt class="xref docutils literal"><span class="pre">executemany()</span></tt></a>,</li>
<li>retrieve data from the database <a class="reference external" href="cursor.html#cursor-iterable"><em>by iteration</em></a> or
using methods such as <a title="cursor.fetchone" class="reference external" href="cursor.html#cursor.fetchone"><tt class="xref docutils literal"><span class="pre">fetchone()</span></tt></a>, <a title="cursor.fetchmany" class="reference external" href="cursor.html#cursor.fetchmany"><tt class="xref docutils literal"><span class="pre">fetchmany()</span></tt></a>,
<a title="cursor.fetchall" class="reference external" href="cursor.html#cursor.fetchall"><tt class="xref docutils literal"><span class="pre">fetchall()</span></tt></a>.</li>
</ul>
</li>
</ul>
<div class="section" id="passing-parameters-to-sql-queries">
<span id="query-parameters"></span><span id="index-257"></span><h2>Passing parameters to SQL queries<a class="headerlink" href="#passing-parameters-to-sql-queries" title="Permalink to this headline">¶</a></h2>
<p>Psycopg casts Python variables to SQL literals by type.  Many standard Python types
are already <a class="reference internal" href="#python-types-adaptation">adapted to the correct SQL representation</a>.</p>
<p>Example: the Python function call:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="gp">... </span>    <span class="sd">&quot;&quot;&quot;INSERT INTO some_table (an_int, a_date, a_string)</span>
<span class="gp">... </span><span class="sd">        VALUES (%s, %s, %s);&quot;&quot;&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2005</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span> <span class="s">&quot;O&#39;Reilly&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>is converted into the SQL command:</p>
<div class="highlight-python"><pre>INSERT INTO some_table (an_int, a_date, a_string)
 VALUES (10, '2005-11-18', 'O''Reilly');</pre>
</div>
<p>Named arguments are supported too using <tt class="docutils literal"><span class="pre">%(</span><em><span class="pre">name</span></em><span class="pre">)s</span></tt> placeholders.
Using named arguments the values can be passed to the query in any order and
many placeholder can use the same values:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="gp">... </span>    <span class="sd">&quot;&quot;&quot;INSERT INTO some_table (an_int, a_date, another_date, a_string)</span>
<span class="gp">... </span><span class="sd">        VALUES (%(int)s, %(date)s, %(date)s, %(str)s);&quot;&quot;&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="p">{</span><span class="s">&#39;int&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s">&#39;str&#39;</span><span class="p">:</span> <span class="s">&quot;O&#39;Reilly&quot;</span><span class="p">,</span> <span class="s">&#39;date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2005</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">18</span><span class="p">)})</span>
</pre></div>
</div>
<p>While the mechanism resembles regular Python strings manipulation, there are a
few subtle differences you should care about when passing parameters to a
query:</p>
<ul>
<li><p class="first">The Python string operator <tt class="docutils literal"><span class="pre">%</span></tt> is not used: the <a title="cursor.execute" class="reference external" href="cursor.html#cursor.execute"><tt class="xref docutils literal"><span class="pre">execute()</span></tt></a>
method accepts a tuple or dictionary of values as second parameter.
<a class="reference internal" href="#sql-injection"><strong>Never</strong> use <tt class="docutils literal"><span class="pre">%</span></tt> or <tt class="docutils literal"><span class="pre">+</span></tt> to merge values
into queries</a>.</p>
</li>
<li><p class="first">The variables placeholder must <em>always be a</em> <tt class="docutils literal"><span class="pre">%s</span></tt>, even if a different
placeholder (such as a <tt class="docutils literal"><span class="pre">%d</span></tt> for integers or <tt class="docutils literal"><span class="pre">%f</span></tt> for floats) may look
more appropriate:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO numbers VALUES (</span><span class="si">%d</span><span class="s">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">42</span><span class="p">,))</span> <span class="c"># WRONG</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO numbers VALUES (</span><span class="si">%s</span><span class="s">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">42</span><span class="p">,))</span> <span class="c"># correct</span>
</pre></div>
</div>
</li>
<li><p class="first">For positional variables binding, <em>the second argument must always be a
tuple</em>, even if it contains a single variable.  And remember that Python
requires a comma to create a single element tuple:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO foo VALUES (</span><span class="si">%s</span><span class="s">)&quot;</span><span class="p">,</span> <span class="s">&quot;bar&quot;</span><span class="p">)</span>    <span class="c"># WRONG</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO foo VALUES (</span><span class="si">%s</span><span class="s">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;bar&quot;</span><span class="p">))</span>  <span class="c"># WRONG</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO foo VALUES (</span><span class="si">%s</span><span class="s">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;bar&quot;</span><span class="p">,))</span> <span class="c"># correct</span>
</pre></div>
</div>
</li>
<li><p class="first">Only variable values should be bound via this method: it shouldn&#8217;t be used
to set table or field names. For these elements, ordinary string formatting
should be used before running <a title="cursor.execute" class="reference external" href="cursor.html#cursor.execute"><tt class="xref docutils literal"><span class="pre">execute()</span></tt></a>.</p>
</li>
</ul>
<div class="section" id="the-problem-with-the-query-parameters">
<span id="sql-injection"></span><span id="index-258"></span><h3>The problem with the query parameters<a class="headerlink" href="#the-problem-with-the-query-parameters" title="Permalink to this headline">¶</a></h3>
<p>The SQL representation for many data types is often not the same of the Python
string representation.  The classic example is with single quotes in
strings: SQL uses them as string constants bounds and requires them to be
escaped, whereas in Python single quotes can be left unescaped in strings
bounded by double quotes. For this reason a naïve approach to the composition
of query strings, e.g. using string concatenation, is a recipe for terrible
problems:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">SQL</span> <span class="o">=</span> <span class="s">&quot;INSERT INTO authors (name) VALUES (&#39;</span><span class="si">%s</span><span class="s">&#39;);&quot;</span> <span class="c"># NEVER DO THIS</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;O&#39;Reilly&quot;</span><span class="p">,</span> <span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span> <span class="c"># THIS WILL FAIL MISERABLY</span>
<span class="go">ProgrammingError: syntax error at or near &quot;Reilly&quot;</span>
<span class="go">LINE 1: INSERT INTO authors (name) VALUES (&#39;O&#39;Reilly&#39;)</span>
<span class="go">                                              ^</span>
</pre></div>
</div>
<p>If the variable containing the data to be sent to the database comes from an
untrusted source (e.g. a form published on a web site) an attacker could
easily craft a malformed string, either gaining access to unauthorized data or
performing destructive operations on the database. This form of attack is
called <a class="reference external" href="http://en.wikipedia.org/wiki/SQL_injection">SQL injection</a> and is known to be one of the most widespread forms of
attack to servers. Before continuing, please print <a class="reference external" href="http://xkcd.com/327/">this page</a> as a memo and
hang it onto your desk.</p>
<p>Psycopg can <a class="reference internal" href="#python-types-adaptation">convert automatically Python objects into and from SQL
literals</a>: using this feature your code will result more robust and
reliable. It is really the case to stress this point:</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Never, <strong>never</strong>, <strong>NEVER</strong> use Python string concatenation (<tt class="docutils literal"><span class="pre">+</span></tt>) or
string parameters interpolation (<tt class="docutils literal"><span class="pre">%</span></tt>) to pass variables to a SQL query
string.  Not even at gunpoint.</p>
</div>
<p>The correct way to pass variables in a SQL command is using the second
argument of the <a title="cursor.execute" class="reference external" href="cursor.html#cursor.execute"><tt class="xref docutils literal"><span class="pre">execute()</span></tt></a> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">SQL</span> <span class="o">=</span> <span class="s">&quot;INSERT INTO authors (name) VALUES (</span><span class="si">%s</span><span class="s">);&quot;</span> <span class="c"># Notice: no quotes</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;O&#39;Reilly&quot;</span><span class="p">,</span> <span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="c"># Notice: no % operator</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="adaptation-of-python-values-to-sql-types">
<span id="python-types-adaptation"></span><span id="index-259"></span><h2>Adaptation of Python values to SQL types<a class="headerlink" href="#adaptation-of-python-values-to-sql-types" title="Permalink to this headline">¶</a></h2>
<p>Many standards Python types are adapted into SQL and returned as Python
objects when a query is executed.</p>
<p>If you need to convert other Python types to and from PostgreSQL data types,
see <a class="reference external" href="advanced.html#adapting-new-types"><em>Adapting new Python types to SQL syntax</em></a> and <a class="reference external" href="advanced.html#type-casting-from-sql-to-python"><em>Type casting of SQL types into Python objects</em></a>.  You
can also find a few other specialized adapters in the <a title="" class="reference external" href="extras.html#module-psycopg2.extras"><tt class="xref docutils literal"><span class="pre">psycopg2.extras</span></tt></a>
module.</p>
<p>In the following examples the method <a title="cursor.mogrify" class="reference external" href="cursor.html#cursor.mogrify"><tt class="xref docutils literal"><span class="pre">mogrify()</span></tt></a> is used to show
the SQL string that would be sent to the database.</p>
<ul id="index-260">
<li><p class="first">Python <tt class="xref docutils literal"><span class="pre">None</span></tt> and boolean values are converted into the proper SQL
literals:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">mogrify</span><span class="p">(</span><span class="s">&quot;SELECT </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="s">&#39;SELECT NULL, true, false;&#39;</span>
</pre></div>
</div>
</li>
</ul>
<ul id="index-261">
<li><p class="first">Numeric objects: <tt class="xref docutils literal"><span class="pre">int</span></tt>, <tt class="xref docutils literal"><span class="pre">long</span></tt>, <tt class="xref docutils literal"><span class="pre">float</span></tt>,
<tt class="xref docutils literal"><span class="pre">Decimal</span></tt> are converted in the PostgreSQL numerical representation:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">mogrify</span><span class="p">(</span><span class="s">&quot;SELECT </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="il">10L</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&quot;10.00&quot;</span><span class="p">)))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="s">&#39;SELECT 10, 10, 10.0, 10.00;&#39;</span>
</pre></div>
</div>
</li>
</ul>
<ul class="simple" id="index-262">
<li>String types: <tt class="xref docutils literal"><span class="pre">str</span></tt>, <tt class="xref docutils literal"><span class="pre">unicode</span></tt> are converted in SQL string
syntax.  <tt class="xref docutils literal"><span class="pre">buffer</span></tt> is converted in PostgreSQL binary string syntax,
suitable for <tt class="sql docutils literal"><span class="pre">bytea</span></tt> fields. When reading textual fields, either
<tt class="xref docutils literal"><span class="pre">str</span></tt> or <tt class="xref docutils literal"><span class="pre">unicode</span></tt> can be received: see
<a class="reference internal" href="#unicode-handling"><em>Unicode handling</em></a>.</li>
</ul>
<ul id="index-263">
<li><p class="first">Date and time objects: builtin <tt class="xref docutils literal"><span class="pre">datetime</span></tt>, <tt class="xref docutils literal"><span class="pre">date</span></tt>,
<tt class="xref docutils literal"><span class="pre">time</span></tt>.  <tt class="xref docutils literal"><span class="pre">timedelta</span></tt> are converted into PostgreSQL&#8217;s
<tt class="sql docutils literal"><span class="pre">timestamp</span></tt>, <tt class="sql docutils literal"><span class="pre">date</span></tt>, <tt class="sql docutils literal"><span class="pre">time</span></tt>, <tt class="sql docutils literal"><span class="pre">interval</span></tt> data types.
Time zones are supported too.  The Egenix <a class="reference external" href="http://www.egenix.com/products/python/mxBase/mxDateTime/">mx.DateTime</a> objects are adapted
the same way:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span>
<span class="go">datetime.datetime(2010, 2, 8, 1, 40, 27, 425337)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">mogrify</span><span class="p">(</span><span class="s">&quot;SELECT </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span> <span class="n">dt</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
<span class="go">&quot;SELECT &#39;2010-02-08T01:40:27.425337&#39;, &#39;2010-02-08&#39;, &#39;01:40:27.425337&#39;;&quot;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">mogrify</span><span class="p">(</span><span class="s">&quot;SELECT </span><span class="si">%s</span><span class="s">;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">dt</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),))</span>
<span class="go">&quot;SELECT &#39;38 days 6027.425337 seconds&#39;;&quot;</span>
</pre></div>
</div>
</li>
</ul>
<ul id="index-264">
<li><p class="first">Python lists are converted into PostgreSQL <tt class="sql docutils literal"><span class="pre">ARRAY</span></tt>s:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">mogrify</span><span class="p">(</span><span class="s">&quot;SELECT </span><span class="si">%s</span><span class="s">;&quot;</span><span class="p">,</span> <span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span> <span class="p">))</span>
<span class="go">&#39;SELECT ARRAY[10, 20, 30];&#39;</span>
</pre></div>
</div>
</li>
</ul>
<ul id="index-265">
<li><p class="first">Python tuples are converted in a syntax suitable for the SQL <tt class="sql docutils literal"><span class="pre">IN</span></tt>
operator:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">mogrify</span><span class="p">(</span><span class="s">&quot;SELECT </span><span class="si">%s</span><span class="s"> IN </span><span class="si">%s</span><span class="s">;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">)))</span>
<span class="go">&#39;SELECT 10 IN (10, 20, 30);&#39;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">SQL doesn&#8217;t allow an empty list in the IN operator, so your code should
guard against empty tuples.</p>
</div>
<p>
<span class="versionmodified">New in version 2.0.6: </span>the tuple <tt class="sql docutils literal"><span class="pre">IN</span></tt> adaptation.</p>
<p>
<span class="versionmodified">Changed in version 2.0.14: </span>the tuple <tt class="sql docutils literal"><span class="pre">IN</span></tt> adapter is always active.  In previous releases it
was necessary to import the <a title="" class="reference external" href="extensions.html#module-psycopg2.extensions"><tt class="xref docutils literal"><span class="pre">extensions</span></tt></a> module to have it
registered.</p>
</li>
</ul>
<div class="section" id="unicode-handling">
<span id="index-266"></span><span id="id6"></span><h3>Unicode handling<a class="headerlink" href="#unicode-handling" title="Permalink to this headline">¶</a></h3>
<p>Psycopg can exchange Unicode data with a PostgreSQL database.  Python
<tt class="xref docutils literal"><span class="pre">unicode</span></tt> objects are automatically <em>encoded</em> in the client encoding
defined on the database connection (the <a class="reference external" href="http://www.postgresql.org/docs/8.4/static/multibyte.html">PostgreSQL encoding</a>, available in
<a title="connection.encoding" class="reference external" href="connection.html#connection.encoding"><tt class="xref docutils literal"><span class="pre">connection.encoding</span></tt></a>, is translated into a <a class="reference external" href="http://docs.python.org/library/codecs.html#standard-encodings">Python codec</a> using the
<a title="psycopg2.extensions.encodings" class="reference external" href="extensions.html#psycopg2.extensions.encodings"><tt class="xref docutils literal"><span class="pre">encodings</span></tt></a> mapping):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">u</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<span class="go">àèìòù€ &lt;type &#39;unicode&#39;&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO test (num, data) VALUES (</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">);&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">74</span><span class="p">,</span> <span class="n">u</span><span class="p">))</span>
</pre></div>
</div>
<p>When reading data from the database, the strings returned are usually 8 bit
<tt class="xref docutils literal"><span class="pre">str</span></tt> objects encoded in the database client encoding:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">conn</span><span class="o">.</span><span class="n">encoding</span>
<span class="go">UTF8</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT data FROM test WHERE num = 74&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">x</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="go">àèìòù€ &lt;type &#39;str&#39;&gt; &#39;\xc3\xa0\xc3\xa8\xc3\xac\xc3\xb2\xc3\xb9\xe2\x82\xac&#39;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">set_client_encoding</span><span class="p">(</span><span class="s">&#39;LATIN9&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT data FROM test WHERE num = 74&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="go">&lt;type &#39;str&#39;&gt; &#39;\xe0\xe8\xec\xf2\xf9\xa4&#39;</span>
</pre></div>
</div>
<p>In order to obtain <tt class="xref docutils literal"><span class="pre">unicode</span></tt> objects instead, it is possible to
register a typecaster so that PostgreSQL textual types are automatically
<em>decoded</em> using the current client encoding:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">register_type</span><span class="p">(</span><span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT data FROM test WHERE num = 74&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">x</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="go">àèìòù€ &lt;type &#39;unicode&#39;&gt; u&#39;\xe0\xe8\xec\xf2\xf9\u20ac&#39;</span>
</pre></div>
</div>
<p>In the above example, the <a title="psycopg2.extensions.UNICODE" class="reference external" href="extensions.html#psycopg2.extensions.UNICODE"><tt class="xref docutils literal"><span class="pre">UNICODE</span></tt></a> typecaster is
registered only on the cursor. It is also possible to register typecasters on
the connection or globally: see the function
<a title="psycopg2.extensions.register_type" class="reference external" href="extensions.html#psycopg2.extensions.register_type"><tt class="xref docutils literal"><span class="pre">register_type()</span></tt></a> and
<a class="reference external" href="advanced.html#type-casting-from-sql-to-python"><em>Type casting of SQL types into Python objects</em></a> for details.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If you want to receive uniformly all your database input in Unicode, you
can register the related typecasters globally as soon as Psycopg is
imported:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">import</span> <span class="nn">psycopg2.extensions</span>
<span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">register_type</span><span class="p">(</span><span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
<span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">register_type</span><span class="p">(</span><span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">UNICODEARRAY</span><span class="p">)</span>
</pre></div>
</div>
<p class="last">and then forget about this story.</p>
</div>
</div>
</div>
<div class="section" id="transactions-control">
<span id="index-267"></span><span id="id9"></span><h2>Transactions control<a class="headerlink" href="#transactions-control" title="Permalink to this headline">¶</a></h2>
<p>In Psycopg transactions are handled by the <a title="connection" class="reference external" href="connection.html#connection"><tt class="xref docutils literal"><span class="pre">connection</span></tt></a> class. By
default, the first time a command is sent to the database (using one of the
<a title="cursor" class="reference external" href="cursor.html#cursor"><tt class="xref docutils literal"><span class="pre">cursor</span></tt></a>s created by the connection), a new transaction is created.
The following database commands will be executed in the context of the same
transaction &#8211; not only the commands issued by the first cursor, but the ones
issued by all the cursors created by the same connection.  Should any command
fail, the transaction will be aborted and no further command will be executed
until a call to the <a title="connection.rollback" class="reference external" href="connection.html#connection.rollback"><tt class="xref docutils literal"><span class="pre">connection.rollback()</span></tt></a> method.</p>
<p>The connection is responsible to terminate its transaction, calling either the
<a title="connection.commit" class="reference external" href="connection.html#connection.commit"><tt class="xref docutils literal"><span class="pre">commit()</span></tt></a> or <a title="connection.rollback" class="reference external" href="connection.html#connection.rollback"><tt class="xref docutils literal"><span class="pre">rollback()</span></tt></a> method.  Committed
changes are immediately made persistent into the database.  Closing the
connection using the <a title="connection.close" class="reference external" href="connection.html#connection.close"><tt class="xref docutils literal"><span class="pre">close()</span></tt></a> method or destroying the
connection object (calling <tt class="xref docutils literal"><span class="pre">__del__()</span></tt> or letting it fall out of scope)
will result in an implicit <tt class="xref docutils literal"><span class="pre">rollback()</span></tt> call.</p>
<p>It is possible to set the connection in <em>autocommit</em> mode: this way all the
commands executed will be immediately committed and no rollback is possible. A
few commands (e.g. <tt class="sql docutils literal"><span class="pre">CREATE</span> <span class="pre">DATABASE</span></tt>, <tt class="sql docutils literal"><span class="pre">VACUUM</span></tt>...) require to be run
outside any transaction: in order to be able to run these commands from
Psycopg, the session must be in autocommit mode.  Read the documentation for
<a title="connection.set_isolation_level" class="reference external" href="connection.html#connection.set_isolation_level"><tt class="xref docutils literal"><span class="pre">connection.set_isolation_level()</span></tt></a> to know how to change the commit mode.</p>
</div>
<div class="section" id="server-side-cursors">
<span id="index-268"></span><span id="id10"></span><h2>Server side cursors<a class="headerlink" href="#server-side-cursors" title="Permalink to this headline">¶</a></h2>
<p>When a database query is executed, the Psycopg <a title="cursor" class="reference external" href="cursor.html#cursor"><tt class="xref docutils literal"><span class="pre">cursor</span></tt></a> usually fetches
all the records returned by the backend, transferring them to the client
process. If the query returned an huge amount of data, a proportionally large
amount of memory will be allocated by the client.</p>
<p>If the dataset is too large to be practically handled on the client side, it is
possible to create a <em>server side</em> cursor. Using this kind of cursor it is
possible to transfer to the client only a controlled amount of data, so that a
large dataset can be examined without keeping it entirely in memory.</p>
<p>Server side cursor are created in PostgreSQL using the <a class="reference external" href="http://www.postgresql.org/docs/8.4/static/sql-declare.html"><tt class="sql docutils literal"><span class="pre">DECLARE</span></tt></a> command and
subsequently handled using <tt class="sql docutils literal"><span class="pre">MOVE</span></tt>, <tt class="sql docutils literal"><span class="pre">FETCH</span></tt> and <tt class="sql docutils literal"><span class="pre">CLOSE</span></tt> commands.</p>
<p>Psycopg wraps the database server side cursor in <em>named cursors</em>. A named
cursor is created using the <a title="connection.cursor" class="reference external" href="connection.html#connection.cursor"><tt class="xref docutils literal"><span class="pre">cursor()</span></tt></a> method specifying the
<tt class="xref docutils literal"><span class="pre">name</span></tt> parameter. Such cursor will behave mostly like a regular cursor,
allowing the user to move in the dataset using the <a title="cursor.scroll" class="reference external" href="cursor.html#cursor.scroll"><tt class="xref docutils literal"><span class="pre">scroll()</span></tt></a>
method and to read the data using <a title="cursor.fetchone" class="reference external" href="cursor.html#cursor.fetchone"><tt class="xref docutils literal"><span class="pre">fetchone()</span></tt></a> and
<a title="cursor.fetchmany" class="reference external" href="cursor.html#cursor.fetchmany"><tt class="xref docutils literal"><span class="pre">fetchmany()</span></tt></a> methods.</p>
</div>
<div class="section" id="thread-safety">
<span id="index-269"></span><span id="id11"></span><h2>Thread safety<a class="headerlink" href="#thread-safety" title="Permalink to this headline">¶</a></h2>
<p>The Psycopg module is <em>thread-safe</em>: threads can access the same database
using separate sessions (by creating a <a title="connection" class="reference external" href="connection.html#connection"><tt class="xref docutils literal"><span class="pre">connection</span></tt></a> per thread) or using
the same session (accessing to the same connection and creating separate
<a title="cursor" class="reference external" href="cursor.html#cursor"><tt class="xref docutils literal"><span class="pre">cursor</span></tt></a>s). In <a class="reference external" href="http://www.python.org/dev/peps/pep-0249/">DB API 2.0</a> parlance, Psycopg is <em>level 2 thread safe</em>.</p>
</div>
<div class="section" id="using-copy-to-and-copy-from">
<span id="copy"></span><span id="index-270"></span><h2>Using COPY TO and COPY FROM<a class="headerlink" href="#using-copy-to-and-copy-from" title="Permalink to this headline">¶</a></h2>
<p>Psycopg <a title="cursor" class="reference external" href="cursor.html#cursor"><tt class="xref docutils literal"><span class="pre">cursor</span></tt></a> objects provide an interface to the efficient
PostgreSQL <a class="reference external" href="http://www.postgresql.org/docs/8.4/static/sql-copy.html"><tt class="sql docutils literal"><span class="pre">COPY</span></tt></a> command to move data from files to tables and back.
The methods exposed are:</p>
<dl class="docutils">
<dt><a title="cursor.copy_from" class="reference external" href="cursor.html#cursor.copy_from"><tt class="xref docutils literal"><span class="pre">copy_from()</span></tt></a></dt>
<dd>Reads data <em>from</em> a file-like object appending them to a database table
(<tt class="sql docutils literal"><span class="pre">COPY</span> <span class="pre">table</span> <span class="pre">FROM</span> <span class="pre">file</span></tt> syntax). The source file must have both
<tt class="xref docutils literal"><span class="pre">read()</span></tt> and <tt class="xref docutils literal"><span class="pre">readline()</span></tt> method.</dd>
<dt><a title="cursor.copy_to" class="reference external" href="cursor.html#cursor.copy_to"><tt class="xref docutils literal"><span class="pre">copy_to()</span></tt></a></dt>
<dd>Writes the content of a table <em>to</em> a file-like object (<tt class="sql docutils literal"><span class="pre">COPY</span> <span class="pre">table</span> <span class="pre">TO</span>
<span class="pre">file</span></tt> syntax). The target file must have a <tt class="xref docutils literal"><span class="pre">write()</span></tt> method.</dd>
<dt><a title="cursor.copy_expert" class="reference external" href="cursor.html#cursor.copy_expert"><tt class="xref docutils literal"><span class="pre">copy_expert()</span></tt></a></dt>
<dd>Allows to handle more specific cases and to use all the <tt class="sql docutils literal"><span class="pre">COPY</span></tt>
features available in PostgreSQL.</dd>
</dl>
<p>Please refer to the documentation of the single methods for details and
examples.</p>
</div>
<div class="section" id="access-to-postgresql-large-objects">
<span id="large-objects"></span><span id="index-271"></span><h2>Access to PostgreSQL large objects<a class="headerlink" href="#access-to-postgresql-large-objects" title="Permalink to this headline">¶</a></h2>
<p>PostgreSQL offers support to <a class="reference external" href="http://www.postgresql.org/docs/8.4/static/largeobjects.html">large objects</a>, which provide stream-style
access to user data that is stored in a special large-object structure. They
are useful with data values too large to be manipulated conveniently as a
whole.</p>
<p>Psycopg allows access to the large object using the
<a title="psycopg2.extensions.lobject" class="reference external" href="extensions.html#psycopg2.extensions.lobject"><tt class="xref docutils literal"><span class="pre">lobject</span></tt></a> class. Objects are generated using the
<a title="connection.lobject" class="reference external" href="connection.html#connection.lobject"><tt class="xref docutils literal"><span class="pre">connection.lobject()</span></tt></a> factory method.</p>
<p>Psycopg large object support efficient import/export with file system files
using the <a class="reference external" href="http://www.postgresql.org/docs/8.4/static/lo-interfaces.html#AEN36307"><tt class="xref docutils literal"><span class="pre">lo_import()</span></tt></a> and <a class="reference external" href="http://www.postgresql.org/docs/8.4/static/lo-interfaces.html#AEN36330"><tt class="xref docutils literal"><span class="pre">lo_export()</span></tt></a> libpq functions.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="#">Basic module usage</a><ul>
<li><a class="reference external" href="#passing-parameters-to-sql-queries">Passing parameters to SQL queries</a><ul>
<li><a class="reference external" href="#the-problem-with-the-query-parameters">The problem with the query parameters</a></li>
</ul>
</li>
<li><a class="reference external" href="#adaptation-of-python-values-to-sql-types">Adaptation of Python values to SQL types</a><ul>
<li><a class="reference external" href="#unicode-handling">Unicode handling</a></li>
</ul>
</li>
<li><a class="reference external" href="#transactions-control">Transactions control</a></li>
<li><a class="reference external" href="#server-side-cursors">Server side cursors</a></li>
<li><a class="reference external" href="#thread-safety">Thread safety</a></li>
<li><a class="reference external" href="#using-copy-to-and-copy-from">Using COPY TO and COPY FROM</a></li>
<li><a class="reference external" href="#access-to-postgresql-large-objects">Access to PostgreSQL large objects</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="index.html"
                                  title="previous chapter">Psycopg &#8211; PostgreSQL database adapter for Python</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="module.html"
                                  title="next chapter">The <tt class="docutils literal docutils literal docutils literal"><span class="pre">psycopg2</span></tt> module content</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/usage.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="modindex.html" title="Global Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="module.html" title="The psycopg2 module content"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Psycopg – PostgreSQL database adapter for Python"
             >previous</a> |</li>
        <li><a href="index.html">Psycopg v2.0.14 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2001-2010, Federico Di Gregorio. Documentation by Daniele Varrazzo.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.4.
    </div>
  </body>
</html>